---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# OmopSketch <a href="https://oxford-pharmacoepi.github.io/OmopSketch/"><img src="man/figures/logo.png" align="right" height="138" alt="OmopSketch website" /></a>

<!-- badges: start -->
[![Lifecycle: experimental](https://img.shields.io/badge/lifecycle-experimental-orange.svg)](https://lifecycle.r-lib.org/articles/stages.html#experimental)
[![R-CMD-check](https://github.com/oxford-pharmacoepi/OmopSketch/actions/workflows/R-CMD-check.yaml/badge.svg)](https://github.com/oxford-pharmacoepi/OmopSketch/actions/workflows/R-CMD-check.yaml)
[![CRAN status](https://www.r-pkg.org/badges/version/OmopSketch)](https://CRAN.R-project.org/package=OmopSketch)
[![Codecov test coverage](https://codecov.io/gh/oxford-pharmacoepi/OmopSketch/branch/main/graph/badge.svg)](https://app.codecov.io/gh/oxford-pharmacoepi/OmopSketch?branch=main)
<!-- badges: end -->

### WARNING: this package is under-development and has only been tested using mock data

The goal of OmopSketch is to characterise and visualise an OMOP CDM instance to asses if it meets the necessary criteria to answer a specific clinical question and conduct a certain study.

## Installation

You can install the development version of OmopSketch from [GitHub](https://github.com/) with:

``` r
# install.packages("remotes")
remotes::install_github("oxford-pharmacoepi/OmopSketch")
```

## Example

Let's start by creating a cdm object using the Eunomia mock dataset:

```{r, message=TRUE, warning=FALSE}
library(duckdb)
library(CDMConnector)
library(dplyr, warn.conflicts = FALSE)
library(OmopSketch)
con <- dbConnect(duckdb(), eunomia_dir())
cdm <- cdmFromCon(con = con, cdmSchema = "main", writeSchema = "main")
cdm
```
### Snapshot
We first create a snapshot of our database. This will allow us to track when the analysis has been conducted and capture details about the CDM version or the data release.
```{r}
summariseOmopSnapshot(cdm) |>
  tableOmopSnapshot()
```


### Characterise the clinical tables
Once we have collected the snapshot information, we can start characteristing the clinical tables of the CDM. By using `summariseClinicalRecords()` and `tableClinicalRecords()`, we can easily visualise the main characteristics of specific clinical tables. 

```{r}
summariseClinicalRecords(cdm, c("condition_occurrence", "drug_exposure")) |>
  tableClinicalRecords()
```

We can also explore trends in the clinical table records over time.

```{r}
summariseRecordCount(cdm, c("condition_occurrence", "drug_exposure")) |>
  plotRecordCount(facet = "omop_table")
```
### Characterise the observation period
After visualising the main characteristics of our clinical tables, we can explore the observation period details. OmopSketch provides several functions to have an overwied of the dataset study period.

Using `summariseInObservation()` and `plotInObservation()`, we can gather information on the number of records per year.

```{r}
summariseInObservation(cdm$observation_period, output = "records") |>
  plotInObservation()
```
You can also visualise and explore the characteristics of the observation period per each individual in the database using `summariseObservationPeriod()`. 
```{r}
summariseObservationPeriod(cdm$observation_period) |>
  tableObservationPeriod()
```

Or if visualisation is prefered, you can easily build a histogram to explore how many participants have more than one observation period.
```{r}
summariseObservationPeriod(cdm$observation_period) |>
  plotObservationPeriod()
```

### Characterise the concepts
OmopSketch also provides functions to explore some of (or all) the concepts in the dataset.
```{r}
acetaminophen <- c(1125315,  1127433, 1127078)

summariseConceptCounts(cdm, conceptId = list("acetaminophen" = acetaminophen)) |>
  filter(estimate_name == "record_count") |> 
  plotConceptCounts()
```

### Characterise the population
Finally, OmopSketch can also help us to characterise the population at the start and end of the observation period.
```{r}
summarisePopulationCharacteristics(cdm) |>
  tablePopulationCharacteristics()
```
As seen, OmopSketch offers multiple functionalities to provide a general overview of a database. Additionally, it includes more tools and arguments that allow for deeper exploration, helping to assess the database's suitability for specific research studies. For further information, please refer to the vignettes.

